#!/usr/bin/env ruby

require "json"
require "pp"

WEBCAM_VID = "0x046d"
WEBCAM_PID = "0x0919"

MIC_VID = "0x0fd9"
MIC_PID = "0x0070"

def main(verbose: false)
  data = JSON.parse(`system_profiler -json SPUSBHostDataType SPUSBDataType`)
  items = data.values.flatten
  debug(items) if ARGV.include?("--debug")
  webcam = find_device items, vid: WEBCAM_VID, pid: WEBCAM_PID
  mic    = find_device items, vid: MIC_VID, pid: MIC_PID
  if verbose
    pp webcam: webcam
    pp mic: mic
  end
  puts "üé•#{ok_emoji(webcam)}/üéôÔ∏è#{ok_emoji(mic)}"
end

def ok_emoji(item)
  if item.nil?
    "üö´"
  else
    "‚úÖ"
  end
end

def find_device(items, vid:, pid:)
  return nil if items.nil?
  items.each do |i|
    item_vid = vendor_id(i)
    item_pid = product_id(i)
    if item_vid.split.first == vid && item_pid.split.first == pid
      return i
    end
    if ch = find_device(i["_items"], vid: vid, pid: pid)
      return ch
    end
  end
  nil
end

def debug(items, prefix: "")
  $stderr.puts "No items!!" if items.empty?
  items.each do |i|
    $stderr.puts describe(i, prefix: prefix)
    if children = i["_items"]
      debug(children, prefix: "#{prefix}#{i["_name"]}//")
    end
  end
end

def describe(item, prefix:)
  "#{prefix}#{item["_name"]}: pid=#{product_id(item)} vid=#{vendor_id(item)} bcd=#{bcd_device(item)}"
end

def product_id(item)
  try_keys item,
    "product_id",
    "USBDeviceKeyProductID"
end

def vendor_id(item)
  try_keys item,
    "vendor_id",
    "USBDeviceKeyVendorID"
end

def bcd_device(item)
  try_keys item,
    "bcd_device"
end

def try_keys(item, *ks)
  ks.each do |k|
    if item.key?(k)
      return item[k]
    end
  end
  return "(missing #{ks.first})"
end

main \
  verbose: ARGV.include?("--verbose")
