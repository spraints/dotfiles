#!/bin/bash -e
#/ Usage: poke -d server.com:8080 -p ssh-to-this.com [-i 127.0.0.13]
#/
#/ Valid options:
#/ -h, --help
#/ -d, --dest host:port    (required) where you want to connect
#/ -p, --proxy [user@]host (required) a host you can ssh to
#/ -i, --ip ip             a local IP address to use

if ! which -s dnsmasq
then
  echo dnsmasq must be installed first.
  exit 1
fi

usage()
{
  cat "$0" | grep ^#/ | cut -c4-
  exit 1
}

ip=127.0.0.13

while [ $# -gt 0 ]
do
  case "$1" in
    -d|--dest)
      dest="$2"
      desthost=`echo $dest | cut -d : -f 1`
      destport=`echo $dest | cut -d : -f 2`
      shift
      shift
      ;;
    -p|--proxy)
      proxy="$2"
      shift
      shift
      ;;
    -i|--ip)
      ip="$2"
      shift
      shift
      ;;
    -h|--help|*)
      usage
      ;;
  esac
done

[ -n "$desthost" -a -n "$destport" -a -n "$proxy" -a -n "$ip" ] || usage
hosts_patch=/tmp/hosts-patch-$$

cleanup()
{
  set +e
  ifconfig lo0 | grep -w $ip              && sudo ifconfig lo0 -alias $ip
  test -f $hosts_patch                    && sudo patch --reverse /etc/hosts $hosts_patch
  test -f $hosts_patch                    && rm -f $hosts_patch
}

trap cleanup EXIT

set -x 

cat >$hosts_patch <<PATCH
0a1
> $ip $desthost
PATCH

sudo ifconfig lo0 alias $ip
sudo patch /etc/hosts $hosts_patch

ssh -L $ip:$destport:$desthost:$destport -N "$proxy"
